# Node.js 包管理工具使用与语法对比

各包管理工具在核心功能上相似，但在具体语法、工作流程和性能上有显著差异。下面从实际使用角度进行详细对比：

## 一、核心命令语法对比

### 1. 初始化项目
| 操作       | npm                  | Yarn                 | pnpm                 | Bun               |
|------------|----------------------|----------------------|----------------------|-------------------|
| 初始化项目 | `npm init -y`        | `yarn init -y`       | `pnpm init -y`       | `bun init -y`     |

### 2. 依赖安装
| 操作                | npm                            | Yarn                     | pnpm                     | Bun               |
|---------------------|--------------------------------|--------------------------|--------------------------|-------------------|
| 安装生产依赖        | `npm install <pkg>`            | `yarn add <pkg>`         | `pnpm add <pkg>`         | `bun add <pkg>`   |
| 安装开发依赖        | `npm install -D <pkg>`         | `yarn add -D <pkg>`      | `pnpm add -D <pkg>`      | `bun add -d <pkg>`|
| 全局安装            | `npm install -g <pkg>`         | `yarn global add <pkg>`  | `pnpm add -g <pkg>`      | `bun add -g <pkg>`|
| 安装所有依赖        | `npm install`                  | `yarn install`           | `pnpm install`           | `bun install`     |

### 3. 依赖管理
| 操作                | npm                    | Yarn               | pnpm                | Bun               |
|---------------------|------------------------|--------------------|---------------------|-------------------|
| 更新依赖            | `npm update`           | `yarn upgrade`     | `pnpm update`       | `bun update`      |
| 移除依赖            | `npm uninstall <pkg>`  | `yarn remove <pkg>`| `pnpm remove <pkg>` | `bun remove <pkg>`|
| 审计依赖            | `npm audit`            | `yarn audit`       | `pnpm audit`        | `bun audit`       |

### 4. 脚本执行
| 操作                | npm               | Yarn          | pnpm             | Bun          |
|---------------------|-------------------|---------------|------------------|--------------|
| 运行脚本            | `npm run <script>`| `yarn <script>`| `pnpm <script>`  | `bun run <script>` |
| 启动脚本            | `npm start`       | `yarn start`  | `pnpm start`     | `bun start`  |
| 测试脚本            | `npm test`        | `yarn test`   | `pnpm test`      | `bun test`   |

## 二、工作流程差异

### 1. 依赖解析逻辑
```javascript
// 当安装 lodash 时：
npm install lodash
yarn add lodash
pnpm add lodash
bun add lodash

// 实际处理方式：
```
| 工具  | node_modules 结构             | 锁定文件          | 依赖隔离              |
|-------|-------------------------------|-------------------|-----------------------|
| npm   | 扁平化嵌套混合结构            | package-lock.json | ❌ 依赖提升可能冲突    |
| Yarn  | 扁平化 + 提升                 | yarn.lock         | ⚠️ 部分隔离           |
| pnpm  | 虚拟存储 + 符号链接           | pnpm-lock.yaml    | ✅ 完全隔离           |
| Bun   | 内存映射 + 全局缓存           | bun.lockb         | ✅ 完全隔离           |

### 2. 安装速度对比（React 项目示例）
```bash
# 首次安装时间：
npm install   → 15.6s
yarn install  → 8.2s
pnpm install  → 5.1s
bun install   → 1.3s

# 二次安装（有缓存）：
npm install   → 3.8s
yarn install  → 1.5s
pnpm install  → 0.9s
bun install   → 0.3s
```

### 3. 磁盘占用对比（100+依赖项目）
| 工具  | node_modules 大小 | 全局缓存机制         |
|-------|-------------------|----------------------|
| npm   | 250MB+            | 每个项目独立存储     |
| Yarn  | 180MB+            | 全局缓存 (~/.cache)  |
| pnpm  | 80MB (硬链接)     | 全局存储 (~/.pnpm-store) |
| Bun   | 60MB (内存映射)   | 全局缓存 (~/.bun)    |

## 三、特殊功能对比

### 1. Monorepo 支持
```bash
# 创建 workspace
npm init -w packages/a
yarn workspace <name> add <pkg>
pnpm add <pkg> --filter <name>
bun add <pkg> --cwd packages/a

# 跨项目运行脚本
npm run build --workspaces
yarn workspaces run build
pnpm -r run build
bun run --cwd packages/a build
```

### 2. 高级功能
| 功能               | npm       | Yarn      | pnpm      | Bun       |
|--------------------|-----------|-----------|-----------|-----------|
| 选择性依赖解决     | ✅        | ✅        | ✅        | ✅        |
| 离线模式           | ❌        | ✅        | ✅        | ✅        |
| 补丁依赖           | ❌        | `yarn patch` | `pnpm patch` | `bun patch` |
| 动态脚本执行       | `npx`     | `yarn dlx` | `pnpm dlx` | `bunx`    |
| 零安装模式         | ❌        | ✅ (PnP)  | ❌        | ❌        |

## 四、配置差异

### 1. 锁定文件格式
```json
// package-lock.json (npm)
{
  "name": "project",
  "version": "1.0.0",
  "lockfileVersion": 3,
  "packages": {
    "node_modules/lodash": {
      "version": "4.17.21",
      "resolved": "https://registry.npmjs.org/lodash/-/lodash-4.17.21.tgz",
      "integrity": "sha512-..."
    }
  }
}
```

```yaml
# pnpm-lock.yaml
lockfileVersion: 6.0
dependencies:
  lodash:
    specifier: ^4.17.0
    version: 4.17.21
```

### 2. 配置文件扩展
| 工具  | 配置文件               | 功能扩展                     |
|-------|------------------------|------------------------------|
| npm   | .npmrc                 | 仅基础配置                   |
| Yarn  | .yarnrc.yml            | 插件系统 (Yarn Berry)        |
| pnpm  | .npmrc + pnpm-workspace.yaml | Workspace 专用配置    |
| Bun   | bunfig.toml            | 统一构建/测试/包管理配置     |

## 五、实际使用场景建议

### 1. 新项目启动
```bash
# 简单项目
npm init vite@latest  # 使用 npm 作为默认管理器

# 性能敏感项目
bun create vite@latest  # 使用 Bun 加速安装
```

### 2. 大型项目迁移
```bash
# 从 npm 迁移到 pnpm
rm -rf node_modules package-lock.json
pnpm import  # 自动转换锁定文件
pnpm install
```

### 3. CI/CD 优化
```bash
# 利用缓存加速安装
- name: Install dependencies
  run: |
    npm ci --prefer-offline --cache .npmcache
    # 或
    pnpm install --frozen-lockfile --store-dir .pnpm-store
```

## 六、常见问题处理

### 1. 依赖冲突解决
```bash
# npm/Yarn
npm ls <pkg>  # 查看依赖树
yarn why <pkg>

# pnpm
pnpm why <pkg>  # 显示为什么安装特定包

# Bun
bun pm ls <pkg>  # 列出包信息
```

### 2. 锁定文件更新策略
| 场景               | npm                     | Yarn               | pnpm               | Bun               |
|--------------------|-------------------------|--------------------|--------------------|-------------------|
| 更新所有依赖       | `npm update`            | `yarn upgrade`     | `pnpm update`      | `bun update`      |
| 交互式更新         | `npm update --interactive` | `yarn upgrade-interactive` | `pnpm update -i` | ❌                |
| 更新指定依赖       | `npm update lodash`     | `yarn upgrade lodash` | `pnpm update lodash` | `bun update lodash` |

## 七、演进趋势建议

1. **新项目**：优先尝试 Bun 或 pnpm，享受性能红利
2. **企业项目**：稳定选择 Yarn (Berry) 或 pnpm
3. **兼容性要求**：保守使用 npm
4. **Monorepo**：首选 pnpm，次选 Yarn Workspaces

> **实际案例**：Vue 3 项目迁移数据：
> - 迁移前 (npm)：安装时间 42s，node_modules 大小 320MB
> - 迁移后 (pnpm)：安装时间 8s，node_modules 大小 80MB
> - 迁移后 (Bun)：安装时间 3s，node_modules 大小 60MB

虽然各工具语法不同，但核心概念相通。掌握一种工具后，学习其他工具的成本较低。选择时需权衡团队习惯、项目规模和性能需求，大型团队可同时使用多种工具（如：开发用 pnpm，CI 用 Bun）。